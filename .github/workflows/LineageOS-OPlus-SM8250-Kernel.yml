name: Build Nameless-15 Kernel with KernelSU

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  CLANG_VERSION: clang-r547379
  GCC_TAG: android-12.1.0_r27
  KERNEL_REPO: https://github.com/Nameless-Projects/android_kernel_oneplus_sm8250
  KERNEL_BRANCH: 15

jobs:
  build:
    name: Build Kernel (${{ matrix.ks }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ks: [rsuntk, backslashxx]

    steps:
    - uses: actions/checkout@v4

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup build environment
      run: |
        echo "BUILD_TIME=$(date "+%y%m%d")" >> $GITHUB_ENV
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 libncurses5-dev
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download Clang
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p clang-aosp
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz
        tar -C clang-aosp -zxvf ${CLANG_VERSION}.tar.gz

    - name: Download GCC
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p gcc-64
        wget -O gcc-aarch64.tar.gz https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${GCC_TAG}.tar.gz
        tar -C gcc-64 -zxvf gcc-aarch64.tar.gz

    - name: Download kernel source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --recursive ${{ env.KERNEL_REPO }} -b ${{ env.KERNEL_BRANCH }} android-kernel --depth=1

    - name: Set up KernelSU
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        if [ "${{ matrix.ks }}" = "rsuntk" ]; then
          curl -LSs https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh | bash -s main
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
        else
          curl -LSs https://raw.githubusercontent.com/backslashxx/KernelSU/master/kernel/setup.sh | bash -s master
          echo "CONFIG_KSU_TAMPER_SYSCALL_TABLE=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
        fi
        sed -i 's/ -dirty//g' scripts/setlocalversion

    - name: Build kernel
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        export ARCH=arm64
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        
        MAKE_ARGS="O=out ARCH=arm64 CC=clang CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android- LD=ld.lld LLVM=1 LLVM_IAS=1"
        
        # Генерируем конфиг
        make $MAKE_ARGS vendor/kona-perf_defconfig
        make $MAKE_ARGS vendor/oplus.config
        
        # Авто-подтверждение всех новых опций KSU
        make $MAKE_ARGS olddefconfig
        
        # Пытаемся собрать. Если упадет - запускаем в один поток, чтобы увидеть КРЕШ
        make -j$(nproc --all) $MAKE_ARGS || make $MAKE_ARGS V=1

    - name: Prepare AnyKernel3
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        rm -rf AnyKernel3/.git*
        cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        cd AnyKernel3
        zip -r ../AK3-Nameless-15-KSU-${{ matrix.ks }}.zip ./*

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Nameless-${{ matrix.ks }}
        path: kernel_workspace/AK3-Nameless-15-KSU-${{ matrix.ks }}.zip
